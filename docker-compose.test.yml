version: "3.9"

services:
  test-db:
    image: postgres
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    ports:
      - "5432:5432"
    volumes:
      - ./TEST-DATA:/var/lib/postgresql/data
    logging: 
      driver: none

  test-zinc:
    image: public.ecr.aws/prabhat/zinc
    depends_on:
      - test-db
    environment:
      - DATA_PATH=/data
      - ZINC_FIRST_ADMIN_USER=test
      - ZINC_FIRST_ADMIN_PASSWORD=test
    ports:
      - "4080:4080"
    volumes:
      - ./TEST-DATA:/data
    logging: 
      driver: none

  test-backend: 
    image: test-backend
    depends_on:
      - test-db
      - test-zinc
    build: 
      context: ./backend
      dockerfile: ./Dockerfile.test
    env_file:
      - .env.backend
    command: dockerize -wait tcp://test-db:5432 -timeout 30s sh -c "yarn prisma db push && yarn dev"
    logging: 
      driver: none

  test-runner: 
    image: test-backend
    depends_on:
      - test-db
      - test-zinc
      - test-backend
    build: 
      context: ./backend
      dockerfile: ./Dockerfile.test
    env_file:
      - .env.backend
    command: dockerize -wait tcp://test-db:5432 -wait tcp://test-backend:3000 -timeout 30s sh -c "yarn test"